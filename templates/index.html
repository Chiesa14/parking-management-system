<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parking Management Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
      .card {
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .alert-badge {
        position: absolute;
        top: -10px;
        right: -10px;
        padding: 5px 10px;
        border-radius: 50%;
        background: red;
        color: white;
      }
      .stat-card {
        text-align: center;
        padding: 20px;
      }
      .stat-card i {
        font-size: 2em;
        margin-bottom: 10px;
      }
      .stat-card .number {
        font-size: 1.5em;
        font-weight: bold;
      }
      .activity-feed {
        max-height: 400px;
        overflow-y: auto;
      }
      .activity-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
      }
      .activity-item:last-child {
        border-bottom: none;
      }
      .unauthorized {
        background-color: #fff3f3;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-dark bg-dark">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">Parking Management Dashboard</span>
        <span class="text-light" id="current-time"></span>
      </div>
    </nav>

    <div class="container-fluid mt-4">
      <div class="row">
        <!-- Statistics Cards -->
        <div class="col-md-3">
          <div class="card stat-card">
            <i class="fas fa-car text-primary"></i>
            <div class="number" id="total-vehicles">0</div>
            <div>Total Vehicles</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card">
            <i class="fas fa-exclamation-triangle text-warning"></i>
            <div class="number" id="unpaid-vehicles">0</div>
            <div>Unpaid Vehicles</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card">
            <i class="fas fa-money-bill-wave text-success"></i>
            <div class="number" id="today-revenue">0</div>
            <div>Today's Revenue</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card">
            <i class="fas fa-chart-line text-info"></i>
            <div class="number" id="occupancy-rate">0%</div>
            <div>Occupancy Rate</div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <!-- Activity Feed -->
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">Real-time Activity</h5>
            </div>
            <div class="card-body activity-feed" id="activity-feed">
              <!-- Activity items will be added here -->
            </div>
          </div>
        </div>

        <!-- Unauthorized Exits -->
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">Unauthorized Exit Attempts</h5>
            </div>
            <div class="card-body activity-feed" id="unauthorized-exits">
              <!-- Unauthorized exit items will be added here -->
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <!-- Hourly Statistics Chart -->
        <div class="col-md-8">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">Hourly Parking Statistics</h5>
            </div>
            <div class="card-body">
              <canvas id="hourlyChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Recent Transactions -->
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">Recent Transactions</h5>
            </div>
            <div class="card-body activity-feed" id="recent-transactions">
              <!-- Transaction items will be added here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Update the socket connection and event handling
      const socket = io({
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionDelayMax: 5000,
        reconnectionAttempts: 5,
      });

      socket.on("connect", () => {
        console.log("Connected to server");
        // Request initial data
        fetch("/api/dashboard_data")
          .then((response) => response.json())
          .then((data) => {
            updateDashboard(data);
          });
      });

      socket.on("disconnect", () => {
        console.log("Disconnected from server");
      });

      socket.on("parking_update", function (data) {
        console.log("Received update:", data);
        if (data.unauthorized_exits) {
          updateUnauthorizedExits(data.unauthorized_exits);
        }
        if (data.latest_activity) {
          updateActivityFeed(data);
        }
        if (data.current_count) {
          updateParkingCount(data.current_count);
        }
        if (data.today_revenue) {
          document.getElementById("today-revenue").textContent =
            data.today_revenue.today_revenue + " RWF";
        }
        if (data.recent_transactions) {
          updateRecentTransactions(data.recent_transactions);
        }
      });

      // Update current time
      function updateTime() {
        document.getElementById("current-time").textContent =
          new Date().toLocaleString();
      }
      setInterval(updateTime, 1000);
      updateTime();

      // Initialize hourly chart
      const hourlyChart = new Chart(document.getElementById("hourlyChart"), {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Vehicle Entries",
              data: [],
              borderColor: "rgb(75, 192, 192)",
              tension: 0.1,
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
            },
          },
        },
      });

      function updateDashboard(data) {
        if (!data) return;

        // Update statistics
        document.getElementById("total-vehicles").textContent =
          data.parking_status.total_vehicles || 0;
        document.getElementById("unpaid-vehicles").textContent =
          data.parking_status.unpaid_vehicles || 0;
        document.getElementById("today-revenue").textContent =
          data.today_revenue.today_revenue + " RWF";

        // Calculate occupancy rate (assuming 100 parking spots)
        const totalSpots = 100;
        const occupancyRate = (
          ((data.parking_status.total_vehicles || 0) / totalSpots) *
          100
        ).toFixed(1);
        document.getElementById("occupancy-rate").textContent =
          occupancyRate + "%";

        // Update hourly chart
        if (data.hourly_stats) {
          updateHourlyChart(data.hourly_stats);
        }

        // Update activity feed
        updateActivityFeed(data);

        // Update unauthorized exits
        const unauthorizedExits = document.getElementById("unauthorized-exits");
        unauthorizedExits.innerHTML = data.unauthorized_exits
          .map(
            (exit) => `
            <div class="activity-item unauthorized">
                <strong>${exit.plate_number}</strong>
                <div>Attempted exit at ${new Date(
                  exit.exit_timestamp
                ).toLocaleString()}</div>
            </div>
        `
          )
          .join("");

        // Update recent transactions
        const recentTransactions = document.getElementById(
          "recent-transactions"
        );
        recentTransactions.innerHTML = data.recent_transactions.slice(1)
          .map(
            (tx) => `
            <div class="activity-item">
                <strong>${tx.plate_number}</strong>
                <div>Amount: ${tx.amount} RWF</div>
                <div>Duration: ${tx.duration_hr} hours</div>
                <div>Time: ${new Date(tx.exit_time).toLocaleString()}</div>
            </div>
        `
          )
          .join("");
      }

      function updateActivityFeed(data) {
        const feed = document.getElementById("activity-feed");
        if (!feed) return;

        // Add new activity
        if (data.latest_activity) {
          const activity = data.latest_activity;
          const time = new Date(activity.entry_timestamp).toLocaleTimeString();
          const status =
            activity.action_type === "ENTRY" ? "entered" : "exited";
          const paymentStatus =
            activity.payment_status === 1 ? "paid" : "unpaid";

          const activityHtml = `
                <div class="activity-item">
                    <div class="activity-icon bg-primary">
                        <i class="fas fa-car"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-header">
                            <span class="activity-title">Vehicle ${status}</span>
                            <span class="activity-time">${time}</span>
                        </div>
                        <p class="activity-text">
                            Plate: ${activity.plate_number}<br>
                            Status: ${paymentStatus}
                        </p>
                    </div>
                </div>
            `;
          feed.insertAdjacentHTML("afterbegin", activityHtml);
        }

        // Keep only last 10 activities
        const activities = feed.getElementsByClassName("activity-item");
        while (activities.length > 10) {
          activities[activities.length - 1].remove();
        }
      }

      function updateParkingCount(data) {
        document.getElementById("total-vehicles").textContent =
          data.current_count || 0;
        document.getElementById("unpaid-vehicles").textContent =
          data.unpaid_count || 0;

        // Recalculate occupancy rate
        const totalSpots = 100;
        const occupancyRate = (
          ((data.current_count || 0) / totalSpots) *
          100
        ).toFixed(1);
        document.getElementById("occupancy-rate").textContent =
          occupancyRate + "%";
      }

      function updateHourlyChart(stats) {
        hourlyChart.data.labels = stats.map((stat) => stat.hour + ":00");
        hourlyChart.data.datasets[0].data = stats.map((stat) => stat.entries);
        hourlyChart.update();
      }

      function updateUnauthorizedExits(exits) {
        const unauthorizedExits = document.getElementById("unauthorized-exits");
        if (!unauthorizedExits) return;

        console.log("Updating unauthorized exits:", exits);

        unauthorizedExits.innerHTML = exits
          .map(
            (exit) => `
            <div class="activity-item unauthorized">
                <div class="activity-icon bg-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-header">
                        <span class="activity-title">Unauthorized Exit Attempt</span>
                        <span class="activity-time">${new Date(
                          exit.exit_timestamp
                        ).toLocaleTimeString()}</span>
                    </div>
                    <p class="activity-text">
                        Plate: ${exit.plate_number}<br>
                        Status: Unauthorized Exit
                    </p>
                </div>
            </div>
        `
          )
          .join("");
      }

      function updateRecentTransactions(transactions) {
        const recentTransactions = document.getElementById(
          "recent-transactions"
        );
        if (!recentTransactions) return;

        console.log("Updating recent transactions:", transactions);

        // Create a Set to track unique transactions
        const uniqueTransactions = new Set();

        recentTransactions.innerHTML = transactions
          .filter((tx) => {
            // Create a unique key for each transaction
            const key = `${tx.plate_number}-${tx.exit_time}-${tx.amount}`;
            if (uniqueTransactions.has(key)) {
              return false;
            }
            uniqueTransactions.add(key);
            return true;
          })
          .map(
            (tx) => `
                <div class="activity-item">
                    <div class="activity-icon bg-success">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-header">
                            <span class="activity-title">Payment Received</span>
                            <span class="activity-time">${new Date(
                              tx.exit_time
                            ).toLocaleTimeString()}</span>
                        </div>
                        <p class="activity-text">
                            Plate: ${tx.plate_number}<br>
                            Amount: ${tx.amount} RWF<br>
                            Duration: ${tx.duration_hr} hours
                        </p>
                    </div>
                </div>
            `
          )
          .join("");
      }
    </script>
  </body>
</html>
